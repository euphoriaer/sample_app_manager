@using SampleAppManager.LiteDB;
@using SampleAppManager.Model;
@using SampleAppManager.Pages.Dialoge;
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@inject ProcessVersionWithStatus ProcessVersionStatus
@inject NotificationService _notice
@inject LiteDbContext ProcessVersionData
@inject Authentication authentication

<Layout Style="min-height: 100vh; ">
	<Sider Collapsible Collapsed=@collapsed OnCollapse=@onCollapse>
		<div class="logo" />
		<Menu Theme="MenuTheme.Dark" DefaultSelectedKeys=@(new[]{ProcessVersionStatus.processVersion[0].VersionName}) Mode="MenuMode.Inline">
			<GridRow Justify="center" Align="middle">
				<NewVersionDialoge title="新版本" OnConfirm="AddNewVersion"></NewVersionDialoge>
			</GridRow>
			@foreach (var item in ProcessVersionStatus.processVersion)
			{
				<MenuItem Key=@item.VersionName OnClick="()=>{VersionClick(item.VersionName);}">
					<span>@item.VersionName</span>
				</MenuItem>
			}
		</Menu>
	</Sider>
	<Layout Class="site-layout">
		<Header Class="site-layout-background" Style=" padding: 0 ;">
			<GridRow Justify="end">
				<Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" Icon="@IconType.Outline.UserSwitch" @onclick=EditorUser>账户管理</Button>
				
				<LoginDialoge title="登录" OnConfirm="Login"></LoginDialoge>
				
			</GridRow>
		</Header>
		@Body
	</Layout>
</Layout>


@code {
	bool collapsed;

	protected override void OnInitialized()
	{
		ProcessVersionStatus.processVersion = new List<ProcessVersion>();
		ProcessVersionStatus.curSelect = new ProcessVersion();
		ProcessVersionStatus.processVersion = ProcessVersionData.ProcessVersions.GetProcessVersion();
		ProcessVersionStatus.curSelect = ProcessVersionStatus.processVersion[0];


	}

	void onCollapse(bool collapsed)
	{
		Console.WriteLine(collapsed);
		this.collapsed = collapsed;
	}

	void AddNewVersion(ProcessVersion version)
	{
		//Todo form  增加新版本
		if (!authentication.isNewVersion)
		{
			return;
		}
		version.RouteName = version.VersionName.Replace(".", "_");
		ProcessVersionData.ProcessVersions.Add(version);
	}


	void Login(UserItem loginUser)
	{
		if (string.IsNullOrEmpty(loginUser.UserName))
		{
			return;
		}
		//Todo  登录
		var users= ProcessVersionData.Users.GetUser(loginUser.UserName);
		if (users.Count==0)
		{
			return;
		}

		if (users[0].Password == loginUser.Password)
		{
			var user = users[0];
			authentication.isUpload = user.UpLoad;
			authentication.isChecking= user.isChecking;
			authentication.isAdmin= user.IsAdmin;
			authentication.isNewVersion= user.IsAdmin;
		}
	}

	void VersionClick(string selectVresion)
	{
		//todo 切到指定版本
		var curSelectProcess = ProcessVersionData.ProcessVersions.GetProcessVersion(selectVresion)
		.Where(o=>o.VersionName==selectVresion)
		.ToList()
		.First();

		ProcessVersionStatus.curSelect = curSelectProcess;
		NavigationManager.NavigateTo($"/ProcessVersion/{ProcessVersionStatus.curSelect.RouteName}");
	}

	async void EditorUser()
	{
		if (!authentication.isAdmin)
		{
			return;
		}
		NavigationManager.NavigateTo("/UserManager");
	}

}


<style>
	#components-layout-demo-side .logo {
		height: 32px;
		background: rgba(255, 255, 255, 0.2);
		margin: 16px;
	}

	.site-layout .site-layout-background {
		background: #fff;
	}
</style>
